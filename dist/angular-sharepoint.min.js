angular.module("ngSharepoint",[]),angular.module("ngSharepoint").factory("CamlBuilder",["CamlTag",function(a){var b=function(){this.camlQuery=new SP.CamlQuery,this.caml=[]};return b.prototype.push=function(b,c,d){var e;return e=b instanceof a?b:new a(b,c,d),this.caml.push(e),e},b.prototype.findByName=function(a){var b=[];return this.caml.forEach(function(c){c.name==a&&b.push(c)}),b},b.prototype.build=function(){for(var a=0;a<this.caml.length;a++)this.caml[a]=this.caml[a].build();return this.camlQuery.set_viewXml(this.caml.join("")),this.camlQuery},b}]),angular.module("ngSharepoint").factory("CamlTag",function(){var a=function(a,b,c){this.name=a,this.attr=b||{},this.value=c,this.caml=[]};return a.prototype.__buildTag=function(){var a=this,b="<";return b+=a.name,Object.getOwnPropertyNames(a.attr).length>0&&Object.getOwnPropertyNames(a.attr).forEach(function(c){b+=" ",b+=c,b+="=",b+='"'+a.attr[c]+'"'}),0===this.caml.length&&angular.isUndefined(this.value)?b+="/>":(b+=">",angular.isDefined(this.value)&&(b+=this.value)),b},a.prototype.push=function(b,c,d){var e;return e=b instanceof a?b:new a(b,c,d),this.caml.push(e),e},a.prototype.setValue=function(a){this.value=a},a.prototype.build=function(){for(var a=this.__buildTag(),b=0;b<this.caml.length;b++)a+=this.caml[b].build();return(this.caml.length>0||angular.isDefined(this.value))&&(a+="</"+this.name+">"),a},a}),angular.module("ngSharepoint").factory("SPContext",["$q","$sp",function(a,b){var c=function(){this.context=b.getContext()};return c.prototype.getLists=function(){var b=this;return a(function(a,c){var d=b.context.get_web().get_lists();b.context.load(d),b.context.executeQueryAsync(function(a,b){for(var c=d.getEnumerator();c.moveNext();){d.get_current()}})})},c}]),angular.module("ngSharepoint").provider("$sp",function(){var a="",b="JSOM";return{setSiteUrl:function(b){a=b},setConnectionMode:function(a){("JSOM"==a||"REST"==a)&&(this.connMode=a)},$get:function(){return{getSiteUrl:function(){return a},getConnectionMode:function(){return b},getContext:function(){return new SP.ClientContext(a)}}}}}),angular.module("ngSharepoint.Lists",["ngSharepoint"]),angular.module("ngSharepoint.Lists").directive("spList",["$spList",function(a){return{restrict:"A",scope:{spList:"@",select:"=spSelect",where:"=spWhere",limit:"=spLimit",order:"=spOrder",asc:"=spAsc"},transclude:!0,template:'<div ng-repeat="item in items" ng-transclude></div>',controller:function(){angular.isUndefined($scope.select)&&($scope.select="*"),angular.isUndefined($scope.asc)&&($scope.asc=!0);var b=a.select($scope.select);angular.isDefined($scope.where)&&b.where($scope.where),angular.isDefined($scope.limit)&&b.limit($scope.limit),angular.isDefined($scope.order)&&b.orderBy($scope.order,$scope.asc),b.then(function(a){$scope.items=a},function(a){console.error(a)})}}}]),angular.module("ngSharepoint.Lists").factory("DeleteQuery",["$q","$sp","CamlBuilder","WhereQuery","Query",function(a,b,c,d,e){var f=function(){return this.__where=[],this.__list=null,this};return f.prototype=new e,f.prototype.from=function(a){return this.__list=a,this},f.prototype.where=function(a){var b=new d(this,a);return this.__where.push(b),b},f.prototype.__execute=function(){var d=this;return a(function(a,e){var f,g=b.getContext(),h=g.get_web().get_lists().getByTitle(d.__list),i=new c,j=i.push("View");if(1===d.__where.length)f=j.push("Query"),d.__where[0].push(f.push("Where"));else if(d.__where.length>1){f=j.push("Query");var k=f.push("Where").push("And");d.__where.forEach(function(a){a.push(k)})}var l=h.getItems(i.build());g.load(l),g.executeQueryAsync(function(b,c){for(var d=l.getEnumerator(),f=[];d.moveNext();){var h=d.get_current();f.push(h)}f.forEach(function(a){a.deleteObject()}),g.executeQueryAsync(function(b,c){a(c)},function(a,b){e(b)})},function(a,b){e(b)})})},f}]),angular.module("ngSharepoint.Lists").factory("InsertIntoQuery",["$q","$sp","Query",function(a,b,c){var d=function(a){return this.__list=a,this.__values={},this};return d.prototype=new c,d.prototype.value=function(a,b){return this.__values[a]=b,this},d.prototype.__execute=function(){var c=this;return a(function(a,d){var e=b.getContext(),f=e.get_web().get_lists().getByTitle(c.__list),g=new SP.ListItemCreationInformation,h=f.addItem(g);c.packItem(h),h.update(),e.load(h),e.executeQueryAsync(function(b,d){a(c.unpackItem(h))},function(a,b){d(b)})})},d}]),angular.module("ngSharepoint.Lists").factory("JoinQuery",["$q","$sp",function(a,b){var c=function(){};return c}]),angular.module("ngSharepoint.Lists").factory("Query",function(){var a=function(){};return a.prototype.unpackItem=function(a){var b=this,c={};return Array.isArray(b.__values)?b.__values.forEach(function(d){var e=a.get_item(d);c[d]=b.__trim(e)}):Object.getOwnPropertyNames(b.__values).forEach(function(d){var e=a.get_item(d);c[d]=b.__trim(e)}),c},a.prototype.packItem=function(a){var b=this;Object.getOwnPropertyNames(b.__values).forEach(function(c){a.set_item(c,b.__trim(b.__values[c]))})},a.prototype.then=function(a,b){return this.__execute().then(a,b)},a.prototype.__trim=function(a){return null!==a&&void 0!==a&&"string"==typeof a?a.trim():a},a}),angular.module("ngSharepoint.Lists").factory("SelectQuery",["$q","$sp","CamlBuilder","Query","WhereQuery",function(a,b,c,d,e){var f=function(a){return this.__values=a,this.__where=[],this.__limit=null,this.__order=[],this};return f.prototype=new d,f.prototype.from=function(a){return this.__list=a,this},f.prototype.where=function(a){var b=new e(this,a);return this.__where.push(b),b},f.prototype.limit=function(a){return this.__limit=a,this},f.prototype.orderBy=function(a,b){return angular.isUndefined(b)&&(b=!0),this.__order.push({field:a,asc:b}),this},f.prototype.__execute=function(){var d=this;return a(function(a,e){var f=b.getContext(),g=f.get_web().get_lists().getByTitle(d.__list),h=new c,i=h.push("View");if(d.__where.length>0||d.__order.length>0){var j=i.push("Query");if(1===d.__where.length){var k=j.push("Where");d.__where[0].push(k)}else if(d.__where.length>1){var l=j.push("Where").push("And");d.__where.forEach(function(a){a.push(l)})}if(d.__order.length>0){var m=j.push("OrderBy");d.__order.forEach(function(a){m.push("FieldRef",{Name:a.field,Ascending:a.asc})})}}var n=i.push("ViewFields");d.__values.forEach(function(a){n.push("FieldRef",{Name:a})}),null!==d.__limit&&i.push("RowLimit",{},d.__limit);var o=g.getItems(h.build());f.load(o),f.executeQueryAsync(function(b,c){for(var e=[],f=o.getEnumerator();f.moveNext();){var g=f.get_current();e.push(d.unpackItem(g))}a(e)},function(a,b){e(b)})})},f}]),angular.module("ngSharepoint.Lists").factory("UpdateQuery",["$q","$sp","CamlBuilder","WhereQuery","Query",function(a,b,c,d,e){var f=function(a){return this.__list=a,this.__values={},this.__where=[],this};return f.prototype=new e,f.prototype.set=function(a,b){return this.__values[a]=b,this},f.prototype.where=function(a){var b=new d(this,a);return this.__where.push(b),b},f.prototype.__execute=function(){var d=this;return a(function(a,e){var f,g=b.getContext(),h=g.get_web().get_lists().getByTitle(d.__list),i=new c,j=i.push("View");if(1===d.__where.length)f=j.push("Query"),d.__where[0].push(f.push("Where"));else if(d.__where.length>1){f=j.push("Query");var k=f.push("Where").push("And");d.__where.forEach(function(a){a.push(k)})}var l=h.getItems(i.build());g.load(l),g.executeQueryAsync(function(b,c){for(var f=l.getEnumerator();f.moveNext();){var h=f.get_current();d.packItem(h),h.update()}g.executeQueryAsync(function(b,c){a(c)},function(a,b){e(b)})},function(a,b){e(b)})})},f}]),angular.module("ngSharepoint.Lists").factory("WhereQuery",function(){var a=function(a,b){this.__query=a,this.__value="",this.__operator="",this.__operators={BEGINS_WITH:["<BeginsWith>","</BeginsWith>"],CONTAINS:["<Contains>","</Contains>"],EQUALS:["<Eq>","</Eq>"],GREATER_EQUALS:["<Geq>","</Geq>"],GREATER:["<Gt>","</Gt>"],INCLUDES:["<Includes>","</Includes>"],IS_NOT_NULL:["<IsNotNull>","</IsNotNull>"],IS_NULL:["<IsNull>","</IsNull>"],LESS_EQUALS:["<Leq>","</Leq>"],LESS:["<Lt>","</Lt>"],NOT_EQUALS:["<Neq>","</Neq>"],NOT_INCLUDES:["<NotIncludes>","</NotIncludes>"]},"string"==typeof b?this.__field=b:(this.__fields=b,this.__operator="equals")};return a.prototype.equals=function(a){return this.__operator="equals",this.__value=a,this.__query},a.prototype.beginsWith=function(a){this.__operator=this.__operators.BEGINS_WITH},a.prototype.push=function(a){var b=this;if(angular.isUndefined(b.__fields)){var c;switch(b.__operator){case"equals":c=a.push("Eq")}c.push("FieldRef",{Name:b.__field}),c.push("Value",{Type:"Number"},b.__value)}else{var d=a.push("And");Object.getOwnPropertyNames(b.__fields).forEach(function(a){var c=d.push("Eq");c.push("FieldRef",{Name:a}),c.push("Value",{Type:"Number"},b.__fields[a])})}},a}),angular.module("ngSharepoint.Lists").factory("$spList",["$sp","SelectQuery","UpdateQuery","InsertIntoQuery","DeleteQuery",function(a,b,c,d,e){return{getList:function(a){return null},select:function(a){return new b(a)},update:function(a){return new c(a)},insertInto:function(a){return new d(a)},"delete":function(){return new e}}}]).factory("SPList",["$q","$http","$sp",function(a,b,c){var d=function(a){this.title=a,"JSOM"==c.getConnectionMode()?this.__list=new f(a):this.__list=new e(a)};d.prototype.insert=function(a){return this.__list.insert(a)},d.prototype.select=function(a){return this.__list.select(a)},d.prototype["delete"]=function(a){return this.__list["delete"](a)};var e=function(a){this.title=a};e.prototype.select=function(d){var e="_api/web/Lists/GetByTitle('"+this.title+"')/GetItems",f={query:{__metadata:{type:"SP.CamlQuery"},ViewXml:d.build()}},g={"X-RequestDigest":$("#__REQUESTDIGEST").val(),Accept:"application/json; odata=verbose","Content-Type":"application/json; odata=verbose"};return a(function(a,d){b({method:"POST",url:c.getSiteUrl()+e,data:f,headers:g}).then(function(a){},d)})},e.prototype.insert=function(d){var e="_api/web/Lists/GetByTitle('"+this.title+"')/items",f={__metadata:{type:"SP.Data.TestListItem"}},g={"X-RequestDigest":$("#__REQUESTDIGEST").val(),Accept:"application/json; odata=verbose","Content-Type":"application/json; odata=verbose"};return Object.getOwnPropertyNames(d).forEach(function(a){var b=d[a];null!==b&&void 0!==b&&"string"==typeof b&&(b=b.trim()),f[a]=b}),a(function(a,d){b({method:"POST",url:c.getSiteUrl()+e,data:f,headers:g}).then(function(a){},d)})};var f=function(a){this.title=a};return f.prototype.select=function(b){return a(function(a,d){var e=c.getContext(),f=e.get_web().get_lists().getByTitle(this.title),g=f.getItems(b.build());e.load(g),e.executeQueryAsync(function(){for(var c=[],d=g.getEnumerator();d.moveNext();){var e=d.get_current();c.push(b.unpackItem(e))}a(c)},function(a,b){d(b)})})},f.prototype.insert=function(b){return a(function(a,d){var e=c.getContext(),f=e.get_web().get_lists().getByTitle(f.title),g=new SP.ListItemCreationInformation,h=f.addItem(g);Object.getOwnPropertyNames(b).forEach(function(a){var c=b[a];null!==c&&void 0!==c&&"string"==typeof c&&(c=c.trim()),h.set_item(a,c)}),h.update(),e.load(h),e.executeQueryAsync(function(b,c){a(query.unpackItem(h))},function(a,b){d(b)})})},f.prototype["delete"]=function(b){return a(function(a,d){var e=c.getContext(),f=e.get_web().get_lists().getByTitle(f.title),g=f.getItems(b);e.load(g),e.executeQueryAsync(function(b,c){for(var f=g.getEnumerator(),h=[];f.moveNext();){var i=f.get_current();h.push(i)}h.forEach(function(a){a.deleteObject()}),e.executeQueryAsync(function(b,c){a(c)},function(a,b){d(b)})},function(a,b){d(b)})})},d}]),angular.module("ngSharepoint.Users",["ngSharepoint"]),angular.module("ngSharepoint.Users").factory("SPUser",["$q","$http","$sp",function(a,b,c){var d=function(b,d){var g=this;return angular.isUndefined(d)&&(d=!0),g.accountName=b,"JSOM"==c.getConnectionMode()?g.__list=new e(b):g.__list=new f(b),d?a(function(a,b){g.load().then(function(a){g.displayName=a.displayName,g.email=a.email,g.picture=a.picture,g.title=a.title,g.personalUrl=a.personalUrl,g.userUrl=a.userUrl,g.properties=a.properties}).then(a,b)}):g};d.prototype.load=function(){return this.__list.load()};var e=function(a){this.accountName=a};e.prototype.load=function(){var b=this;return a(function(a,d){var e=c.getContext(),f=new SP.UserProfiles.PeopleManager(e),g=f.getPropertiesFor(b.accountName);e.load(g),e.executeQueryAsync(function(){var b={};b.displayName=g.get_displayName(),b.email=g.get_email(),b.picture=g.get_pictureUrl(),b.title=g.get_title(),b.personalUrl=g.get_personalUrl(),b.userUrl=g.get_userUrl(),a(b)},d)})};var f=function(a){this.accountName=a};f.prototype.load=function(){var d=this,e="_api/SP.UserProfiles.PeopleManager/getPropertiesFor(@account)?@account='"+d.accountName+"'",f={"X-RequestDigest":$("#__REQUESTDIGEST").val(),Accept:"application/json; odata=verbose","Content-Type":"application/json; odata=verbose"};return a(function(a,d){b({method:"GET",url:c.getSiteUrl()+e,headers:f}).then(function(b){var c={};c.displayName=b.d.DisplayName,c.email=b.d.Email,c.picture=b.d.PictureUrl,c.title=b.d.Title,c.personalUrl=b.d.PersonalUrl,c.userUrl=b.d.UserUrl,a(c)},d)})}}]),angular.module("ngSharepoint.Users").provider("$spUser",["$q","$sp","SPUser",function(a,b,c){return{$get:["$q","$sp",function(a,b){return{getCurrentUser:function(){return a(function(a,c){var d=b.getContext(),e=new SP.UserProfiles.PeopleManager(d),f=e.getMyProperties();d.load(f),d.executeQueryAsync(function(){a(f)},c)})},getUser:function(a){return new c(a)}}}]}}]);